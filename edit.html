<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>게시물 수정 • Clone</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#000; --panel:#111; --text:#fff; --muted:#aaa; --line:#222; --accent:#3897f0;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    .topbar{position:sticky;top:0;z-index:10;height:56px;display:flex;align-items:center;justify-content:center;background:#0a0a0a;border-bottom:1px solid var(--line)}
    .back{position:absolute;left:12px;color:#fff;text-decoration:none;font-size:20px}
    .title{font-weight:700}
    .actions{position:absolute;right:12px;display:flex;gap:8px}
    .btn{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:8px 14px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#2a2a2a}
    .btn.danger{background:#b00020}

    .wrap{display:grid;grid-template-columns:1.2fr .9fr;height:calc(100vh - 56px)}
    @media(max-width:980px){.wrap{grid-template-columns:1fr;height:auto}}

    .canvas{position:relative;background:#0a0a0a;display:flex;align-items:center;justify-content:center;border-right:1px solid var(--line);min-height:420px}
    @media(max-width:980px){.canvas{min-height:300px;border-right:none;border-bottom:1px solid var(--line)}}
    .drop{position:relative;width:min(820px,90%);aspect-ratio:4/3;border:2px dashed #2a2a2a;border-radius:14px;display:flex;align-items:center;justify-content:center;color:#aaa;text-align:center;padding:20px;overflow:hidden;background:#0f0f0f}
    .drop input[type=file]{display:none}
    .drop.dragover{border-color:#666}
    .preview{position:absolute;inset:0;display:none;background:#000 center/contain no-repeat}

    .tag{position:absolute;transform:translate(-50%,-50%);background:rgba(0,0,0,.7);color:#fff;border:1px solid #444;border-radius:14px;padding:4px 8px;font-size:12px;white-space:nowrap;cursor:pointer}

    .side{height:100%;overflow:auto;background:#131313}
    .panel{padding:16px 16px 24px;border-bottom:1px solid var(--line)}
    .me{display:flex;align-items:center;gap:10px}
    .avatar{width:36px;height:36px;border-radius:50%;background:#333}
    .name{font-weight:700}
    .field{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .field label{font-size:14px;color:#ccc}
    .input,textarea{width:100%;background:#0e0e0e;color:#fff;border:1px solid #2a2a2a;border-radius:8px;padding:10px 12px;outline:none}
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .muted{font-size:12px;color:#aaa}

    .accordion summary{list-style:none;cursor:pointer;padding:14px 0;font-weight:600}
    .accordion summary::-webkit-details-marker{display:none}
    .accordion{border-bottom:1px solid var(--line)}
    .pill{border:1px solid #2a2a2a;border-radius:999px;padding:6px 10px;font-size:12px;color:#ddd;display:inline-flex;align-items:center;gap:6px;margin-right:6px;margin-top:6px}
    .pill .x{cursor:pointer}
  </style>
  <link rel="stylesheet" href="/css/my.css">

</head>
<body>
  <div class="topbar">
    <a href="index.html" class="back">←</a>
    <div class="title">게시물 수정</div>
    <div class="actions">
      <button id="deleteBtn" class="btn danger">삭제</button>
      <button id="saveBtn" class="btn">저장</button>
    </div>
  </div>

  <div class="wrap">
    <!-- 이미지 영역 -->
    <section class="canvas">
      <label class="drop" id="dropArea">
        <input id="fileInput" type="file" accept="image/*" />
        <div class="hint">
          <div style="font-size:16px;font-weight:700;margin-bottom:6px">사진 변경(클릭 또는 드래그)</div>
          <div class="muted">JPG/PNG, 최대 10MB</div>
        </div>
        <div id="preview" class="preview"></div>
      </label>
    </section>

    <!-- 폼 영역 -->
    <aside class="side">
      <div class="panel">
        <div class="me">
          <div class="avatar"></div>
          <div class="name">okto.o0o0</div>
        </div>

        <div class="field">
          <div class="row">
            <label for="title">제목</label>
            <div class="muted"><span id="titleCount">0</span>/50</div>
          </div>
          <input id="title" class="input" type="text" maxlength="50" required />
        </div>

        <div class="field">
          <div class="row">
            <label for="desc">설명</label>
            <div class="muted"><span id="descCount">0</span>/2200</div>
          </div>
          <textarea id="desc" maxlength="2200" required></textarea>
        </div>

        <div class="field">
          <label for="location">위치</label>
          <input id="location" class="input" type="text" required />
        </div>

        <div class="field">
          <label for="cowork">공동 작업자 (쉼표 구분)</label>
          <input id="cowork" class="input" type="text" required />
        </div>
      </div>

      <details class="accordion panel" id="acc-tag">
        <summary>사람 태그</summary>
        <div class="muted">이미지 위 원하는 지점을 클릭해 태그를 추가/삭제할 수 있어요. (최대 10개)</div>
        <div id="tagList"></div>
      </details>

      <details class="accordion panel">
        <summary>접근성</summary>
        <div class="field">
          <label for="alt">대체 텍스트(ALT)</label>
          <input id="alt" class="input" type="text" maxlength="100" />
        </div>
        <div class="field">
          <label class="muted"><input type="checkbox" id="allowComments" /> 댓글 허용</label>
        </div>
      </details>
    </aside>
  </div>

  <script>
    // ======= 엘리먼트 =======
    const saveBtn   = document.getElementById('saveBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const fileInput = document.getElementById('fileInput');
    const dropArea  = document.getElementById('dropArea');
    const preview   = document.getElementById('preview');

    const titleEl   = document.getElementById('title');
    const descEl    = document.getElementById('desc');
    const titleCnt  = document.getElementById('titleCount');
    const descCnt   = document.getElementById('descCount');
    const locationEl= document.getElementById('location');
    const coworkEl  = document.getElementById('cowork');
    const altEl     = document.getElementById('alt');
    const allowCk   = document.getElementById('allowComments');
    const tagList   = document.getElementById('tagList');

    // ======= 상태 =======
    const key = 'demo_posts';
    const id  = new URL(location.href).searchParams.get('id');
    let post = null;
    let posts = JSON.parse(localStorage.getItem(key) || '[]');

    // ======= 로드 =======
    function load(){
      post = posts.find(p => p.id === id);
      if(!post){
        alert('게시물을 찾을 수 없습니다.');
        location.href = 'index.html';
        return;
      }
      setPreview(post.image);
      titleEl.value    = post.title || '';
      descEl.value     = post.desc || '';
      locationEl.value = post.location || '';
      coworkEl.value   = post.cowork || '';
      altEl.value      = post.alt || '';
      allowCk.checked  = !!post.allowComments;
      (post.tags || []).forEach(drawTag);
      renderTagList();
      updateCounters();
    }

    // ======= 미리보기/업로드 =======
    function setPreview(url){
      preview.style.display = 'block';
      preview.style.backgroundImage = `url('${url}')`;
      post.image = url;
    }
    function readFile(file){
      if(!file) return;
      if(!file.type.startsWith('image/')){ alert('이미지 파일만 업로드할 수 있어요.'); return; }
      if(file.size > 10*1024*1024){ alert('10MB 이하 이미지만 가능합니다.'); return; }
      const reader = new FileReader();
      reader.onload = () => setPreview(reader.result);
      reader.readAsDataURL(file);
    }
    fileInput.addEventListener('change', e => readFile(e.target.files?.[0]));
    ['dragenter','dragover'].forEach(ev =>
      dropArea.addEventListener(ev, e => {e.preventDefault(); dropArea.classList.add('dragover');})
    );
    ['dragleave','drop'].forEach(ev =>
      dropArea.addEventListener(ev, e => {e.preventDefault(); dropArea.classList.remove('dragover');})
    );
    dropArea.addEventListener('drop', e => readFile(e.dataTransfer?.files?.[0]));

    // ======= 카운터 =======
    function updateCounters(){
      titleCnt.textContent = String(titleEl.value.length);
      descCnt.textContent  = String(descEl.value.length);
    }
    titleEl.addEventListener('input', updateCounters);
    descEl.addEventListener('input',  updateCounters);

    // ======= 태그 추가/삭제 =======
    function uid(){ return 't' + Math.random().toString(36).slice(2,9); }
    preview.addEventListener('click', (e)=>{
      if(!post?.image) return;
      if((post.tags||[]).length >= 10){ alert('태그는 최대 10개까지입니다.'); return; }
      const rect = preview.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 100;
      const y = ((e.clientY - rect.top)  / rect.height) * 100;
      const name = prompt('태그할 이름 (예: @username)');
      if(!name) return;
      const t = { id: uid(), x, y, name: name.trim() };
      post.tags = (post.tags || []);
      post.tags.push(t);
      drawTag(t);
      renderTagList();
    });
    function drawTag(t){
      const el = document.createElement('div');
      el.className = 'tag';
      el.dataset.id = t.id;
      el.textContent = t.name;
      el.style.left = t.x + '%';
      el.style.top  = t.y + '%';
      el.title = '태그 삭제';
      el.addEventListener('click', ()=>{
        post.tags = (post.tags || []).filter(x => x.id !== t.id);
        el.remove();
        renderTagList();
      });
      preview.appendChild(el);
    }
    function renderTagList(){
      tagList.innerHTML = '';
      (post.tags || []).forEach(t=>{
        const pill = document.createElement('span');
        pill.className = 'pill';
        pill.innerHTML = `<span>${t.name}</span><span class="x" title="삭제">✕</span>`;
        pill.querySelector('.x')?.addEventListener('click', ()=>{
          post.tags = post.tags.filter(x=>x.id!==t.id);
          preview.querySelector(`[data-id="${t.id}"]`)?.remove();
          renderTagList();
        });
        tagList.appendChild(pill);
      });
    }

    // ======= Validation =======
    function validateForm(){
      // 제목
      const title = titleEl.value.trim();
      if(title.length < 2 || title.length > 50){
        alert("제목은 2~50자여야 합니다.");
        return false;
      }
      // 설명
      const desc = descEl.value.trim();
      if(desc.length < 5 || desc.length > 2200){
        alert("설명은 5~2200자여야 합니다.");
        return false;
      }
      // 위치
      if(locationEl.value.trim().length < 2){
        alert("위치는 2자 이상 입력해야 합니다.");
        return false;
      }
      // 공동 작업자
      const coworks = coworkEl.value.split(',').map(x=>x.trim()).filter(Boolean);
      if(coworks.length === 0){
        alert("공동 작업자를 최소 1명 이상 입력해야 합니다.");
        return false;
      }
      const re = /^@[\w.]{2,30}$/;
      if(!coworks.every(c=>re.test(c))){
        alert("공동 작업자는 @username 형식이어야 합니다.");
        return false;
      }
      return true;
    }

    // ======= 저장/삭제 =======
    saveBtn.addEventListener('click', ()=>{
      if(!validateForm()) return;
      const doSave = confirm("변경 내용을 저장할까요?");
      if(!doSave) return;

      post.title        = titleEl.value.trim();
      post.desc         = descEl.value.trim();
      post.location     = locationEl.value.trim();
      post.cowork       = coworkEl.value.trim();
      post.alt          = altEl.value.trim();
      post.allowComments= !!allowCk.checked;

      posts = posts.map(p => p.id === post.id ? post : p);
      localStorage.setItem(key, JSON.stringify(posts));

      alert('저장되었습니다.');
      location.href = 'index.html';
    });
    deleteBtn.addEventListener('click', ()=>{
      if(!confirm('이 게시물을 삭제할까요?')) return;
      posts = posts.filter(p => p.id !== id);
      localStorage.setItem(key, JSON.stringify(posts));
      alert('삭제되었습니다.');
      location.href = 'index.html';
    });

    // ======= 시작 =======
    load();
  </script>
</body>
</html>
